version: '2'


volumes:
  redis-data: {{}}


services:

  redis:
    image: redis:3.0
    network_mode: bridge
    volumes:
      - redis-data:/data
      - {redis_conf}:/usr/local/etc/redis/redis.conf
    command: [redis-server, /usr/local/etc/redis/redis.conf]

  crawler:
    image: {docker_image}
    external_links: {external_links}
    network_mode: bridge
    volumes:
      - {seeds}:/dd_crawler/seeds.txt
      - {hints}:/dd_crawler/hints.txt
      - {link_clf}:/dd_crawler/Q.joblib
      - {page_clf}:/dd_crawler/page_clf.joblib
      - {out}:/out
      - {models}:/models
    entrypoint:
      - /dd_crawler/docker/crawl.sh
      - deepdeep
      - -a
      - seeds=/dd_crawler/seeds.txt
      - -a
      - hints=/dd_crawler/hints.txt
      - -a
      - clf=/dd_crawler/Q.joblib
      - -a
      - page_clf=/dd_crawler/page_clf.joblib
      - -a
      - classifier_input=text_url
      - -s
      - CLOSESPIDER_PAGECOUNT={page_limit}
      - -s
      - HTTP_PROXY={proxy}
      - -s
      - HTTPS_PROXY={proxy}
      - -s
      - QUEUE_MAX_RELEVANT_DOMAINS={max_relevant_domains}
      - -s
      - PAGE_RELEVANCY_THRESHOLD={relevancy_threshold}
      - -s
      - FILES_STORE=/out/media
    dns:
      - 127.0.0.1
    links:
      - redis
